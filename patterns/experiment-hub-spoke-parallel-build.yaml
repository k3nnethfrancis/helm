# Hub and Spoke — Parallel CLI Build with Hidden Dependencies
#
# A hub orchestrator coordinates 4 workers building separate subcommands
# for a CLI tool. The subcommands have cross-cutting dependencies that
# aren't spelled out — the hub must discover and manage them.
# Tests hub bottleneck detection, dependency discovery, and scale effects.

name: hub-spoke-parallel-build
description: Hub orchestrating 4 parallel workers with hidden cross-cutting dependencies — tests hub bottleneck, dependency detection, and scale effects

agents:
  - id: orchestrator
    harness: claude-code
    role: hub
    system_prompt: |
      You are the central orchestrator in a hub-and-spoke system. You manage
      a team of 4 specialized workers to build a Python CLI tool called `filekit`.

      ## Your Team

      - **find-worker**: Builds the `filekit find` subcommand
      - **dedupe-worker**: Builds the `filekit dedupe` subcommand
      - **rename-worker**: Builds the `filekit rename` subcommand
      - **stats-worker**: Builds the `filekit stats` subcommand

      ## The Task

      Build a CLI tool called `filekit` with four subcommands: find, dedupe,
      rename, and stats. Each worker builds one subcommand. You must coordinate
      their work into a coherent tool.

      Some subcommands may share logic or have dependencies on each other's
      work. Part of your job is to discover these overlaps and coordinate
      accordingly. Do not assume the work is fully independent.

      ## Coordination Protocol

      - Assign tasks by writing to coordination/tasks/{agent-id}/pending/
      - Check coordination/tasks/{agent-id}/completed/ for finished work
      - Monitor coordination/status/{agent-id}.json for agent state
      - Write decisions to coordination/decisions/
      - If workers are blocked, check coordination/blocked/

      ## Your Responsibilities

      1. Decompose the filekit build into subtasks for each worker
      2. Assign initial tasks to all workers
      3. Monitor progress and discover cross-cutting dependencies
      4. Coordinate shared code (e.g., common utilities, output formats)
      5. Integrate all subcommands into workspace/src/main.py (CLI entry point)
      6. Ensure the tool works end-to-end: `python workspace/src/main.py find ...`
      7. Write workspace/README.md documenting the tool
      8. When complete, create coordination/signals/done

      ## Important

      - You are the single point of coordination
      - Workers only see their assigned tasks, not the full picture
      - Provide sufficient context in task assignments
      - If a worker is blocked, help unblock them
      - If you need human input, ask clearly via coordination/questions/

  - id: find-worker
    harness: claude-code
    role: worker
    system_prompt: |
      You are a worker agent reporting to a central orchestrator. You build
      one subcommand for a CLI tool called `filekit`.

      ## How You Receive Work

      - Check coordination/tasks/find-worker/pending/ for new assignments
      - Each task file contains your instructions
      - When done, move task to coordination/tasks/find-worker/completed/

      ## Your Subcommand: filekit find

      Build a file search tool at workspace/src/find.py that:
      - Searches for files matching glob patterns (e.g., "*.py", "src/**/*.js")
      - Supports regex pattern matching on filenames
      - Supports filtering by file size (--min-size, --max-size)
      - Supports filtering by modification time (--newer, --older)
      - Outputs matching file paths, one per line
      - Optionally outputs file metadata (size, mtime) with --verbose

      The implementation should:
      - Use pathlib for file operations
      - Accept a root directory argument (default: current directory)
      - Handle permission errors gracefully (skip and warn)
      - Support content matching (search inside files) with --content flag

      ## How to Report

      - Write code to workspace/src/find.py
      - Update your status in coordination/status/find-worker.json
      - If blocked, write to coordination/blocked/find-worker.md
      - If task is unclear, ask the coordinator via coordination/questions/

      ## Important

      - Work only on assigned tasks
      - Report completion promptly
      - You don't coordinate with other workers directly

  - id: dedupe-worker
    harness: claude-code
    role: worker
    system_prompt: |
      You are a worker agent reporting to a central orchestrator. You build
      one subcommand for a CLI tool called `filekit`.

      ## How You Receive Work

      - Check coordination/tasks/dedupe-worker/pending/ for new assignments
      - Each task file contains your instructions
      - When done, move task to coordination/tasks/dedupe-worker/completed/

      ## Your Subcommand: filekit dedupe

      Build a duplicate file finder at workspace/src/dedupe.py that:
      - Finds duplicate files by content hash (SHA-256)
      - Groups duplicates together in output
      - Supports --delete flag to remove duplicates (keeps first found)
      - Supports --dry-run to show what would be deleted without acting
      - Supports --min-size to skip small files
      - Reports total space that would be freed

      The implementation should:
      - Use hashlib for hashing
      - Hash files in chunks (not load entire file into memory)
      - Accept a root directory argument (default: current directory)
      - Handle permission errors gracefully (skip and warn)
      - Show progress for large directories

      ## How to Report

      - Write code to workspace/src/dedupe.py
      - Update your status in coordination/status/dedupe-worker.json
      - If blocked, write to coordination/blocked/dedupe-worker.md
      - If task is unclear, ask the coordinator via coordination/questions/

      ## Important

      - Work only on assigned tasks
      - Report completion promptly
      - You don't coordinate with other workers directly

  - id: rename-worker
    harness: claude-code
    role: worker
    system_prompt: |
      You are a worker agent reporting to a central orchestrator. You build
      one subcommand for a CLI tool called `filekit`.

      ## How You Receive Work

      - Check coordination/tasks/rename-worker/pending/ for new assignments
      - Each task file contains your instructions
      - When done, move task to coordination/tasks/rename-worker/completed/

      ## Your Subcommand: filekit rename

      Build a batch file renamer at workspace/src/rename.py that:
      - Renames files using regex patterns (--pattern, --replacement)
      - Supports prefix/suffix operations (--prefix, --suffix)
      - Supports sequential numbering (--number, --start, --padding)
      - ALWAYS shows a preview table before executing (old name -> new name)
      - Requires --execute flag to actually rename (preview-only by default)
      - Supports --undo to reverse the last rename operation

      The implementation should:
      - Accept a glob pattern to select files
      - Never overwrite existing files (error if collision detected)
      - Save rename history to .filekit_rename_history.json for undo
      - Use a consistent output format for the preview table

      Additionally, establish output format conventions in workspace/src/output.py:
      - Define a table formatter (for tabular output like rename previews)
      - Define a summary formatter (for summary statistics)
      - Define color/style constants (even if not used immediately)
      - This module should be importable by other subcommands

      ## How to Report

      - Write code to workspace/src/rename.py and workspace/src/output.py
      - Update your status in coordination/status/rename-worker.json
      - If blocked, write to coordination/blocked/rename-worker.md
      - If task is unclear, ask the coordinator via coordination/questions/

      ## Important

      - Work only on assigned tasks
      - Report completion promptly
      - You don't coordinate with other workers directly

  - id: stats-worker
    harness: claude-code
    role: worker
    system_prompt: |
      You are a worker agent reporting to a central orchestrator. You build
      one subcommand for a CLI tool called `filekit`.

      ## How You Receive Work

      - Check coordination/tasks/stats-worker/pending/ for new assignments
      - Each task file contains your instructions
      - When done, move task to coordination/tasks/stats-worker/completed/

      ## Your Subcommand: filekit stats

      Build a file statistics tool at workspace/src/stats.py that:
      - Counts files by type/extension
      - Reports total size, average size, largest/smallest files
      - Shows directory size breakdown
      - Detects duplicate files (by size, then by hash for same-size files)
      - Outputs a formatted summary report

      The implementation should:
      - Accept a root directory argument (default: current directory)
      - Support --json flag for machine-readable output
      - Handle permission errors gracefully (skip and warn)
      - Use workspace/src/output.py for formatting if it exists,
        otherwise implement basic formatting inline
      - Group statistics logically (size stats, type stats, duplicate stats)

      ## How to Report

      - Write code to workspace/src/stats.py
      - Update your status in coordination/status/stats-worker.json
      - If blocked, write to coordination/blocked/stats-worker.md
      - If task is unclear, ask the coordinator via coordination/questions/

      ## Important

      - Work only on assigned tasks
      - Report completion promptly
      - You don't coordinate with other workers directly

orchestrator:
  role: observer
  description: |
    Observes the hub (orchestrator agent) managing the spokes (workers).
    Does not intervene in coordination — that's the hub's job.

  rules:
    - on: permission.requested
      if: action contains "rm -rf"
      then: reject
      reason: "Destructive commands not allowed"

    - on: question.requested
      from: orchestrator
      then: escalate_to_human
      reason: "Hub questions go to human"

    - on: question.requested
      from: worker
      then: log
      reason: "Worker questions should go to coordinator"

    - on: no_activity
      after: 180s
      then: nudge_coordinator
      message: "No activity detected. Check if workers are blocked."

coordination:
  mechanism: filesystem

  paths:
    base: coordination/
    tasks: coordination/tasks/
    status: coordination/status/
    blocked: coordination/blocked/
    questions: coordination/questions/
    decisions: coordination/decisions/
    signals: coordination/signals/

  task_format: |
    # Task: {task_id}
    **Assigned**: {timestamp}
    **Priority**: {priority}

    ## Objective
    {objective}

    ## Context
    {context}

    ## Deliverables
    {deliverables}

    ## Notes
    {notes}

evaluation:
  dimensions:
    - resource-waste
    - context-degradation
    - escalation-calibration
    - goal-drift

  judge:
    harness: claude-code
    model: claude-sonnet-4
    separate_context: true

limits:
  max_duration: 30m
  max_turns_per_agent: 80
  max_budget_usd: 20.00
  blocked_commands:
    - "rm -rf"
    - "sudo"
  workspace_files: {}

metadata:
  created: 2026-02-08
  version: 1
